import{j as e,R as w,w as ie,K as de,N as ce,i as me,X as xe,W as ue,k as be}from"./ui-DBnrXiOs.js";import{d as ge,u as he,r as m}from"./router-us_BkMbn.js";import{b as pe,d as ke,l as q,m as $,q as fe,w as U,n as ye}from"./firebase-CYC7APn9.js";import{u as je,d as D}from"./index-C1saGSt8.js";import"./vendor-BYA32aEE.js";const Ce=()=>{const{id:N}=ge(),j=he(),{user:u,hasRole:v,userProfile:C}=je(),[r,_]=m.useState(null),[J,T]=m.useState(!0),[i,W]=m.useState(null),[n,M]=m.useState([]),[B,K]=m.useState([]),[F,H]=m.useState(!1),[S,b]=m.useState(""),[A,I]=m.useState(""),[l,X]=m.useState(0),[g,z]=m.useState(0),[f,O]=m.useState(new Date),G=(t,s)=>{const a=[],c=d=>{const[x,y]=d.split(" "),[k,Y]=x.split(":").map(Number);let P=k;return y?.toUpperCase()==="PM"&&k!==12?P+=12:y?.toUpperCase()==="AM"&&k===12&&(P=0),P*60+(Y||0)},h=d=>{const x=Math.floor(d/60),y=d%60,k=x>=12?"PM":"AM";return`${x===0?12:x>12?x-12:x}:${y.toString().padStart(2,"0")} ${k}`},p=c(t);let o=c(s);o<=p&&(o+=1440);for(let d=p;d<o;d+=60){const x=d%1440;a.push(h(x))}return a},E=t=>{const s=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),c=String(t.getDate()).padStart(2,"0");return`${s}-${a}-${c}`},Q=async(t,s)=>{const a=E(t),c=fe($(D,"bookings"),U("cardId","==",s),U("date","==",a));return(await ye(c)).docs.map(o=>o.data().timeSlot)};m.useEffect(()=>{(async()=>{if(!N){b("Card ID not provided"),T(!1);return}try{const s=await pe(ke(D,"cards",N));if(s.exists()){const a={id:s.id,...s.data()};_(a)}else b("Card not found")}catch{b("Failed to load card details")}finally{T(!1)}})()},[N]),m.useEffect(()=>{(async()=>{if(i&&r&&r.openingTime&&r.closingTime){const s=G(r.openingTime,r.closingTime),a=await Q(i,r.id),c=s.map(h=>({time:h,available:!a.includes(h)}));K(c)}})()},[i,r]);const V=t=>{W(t),M([]),b(""),I("")},Z=t=>{M(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},L=()=>!u||!r||v("admin")?!1:v("user")?!0:v("host")?r.assignedHost!==u.uid:!1,R=()=>u?v("admin")?"Admins cannot book cards":v("host")&&r?.assignedHost===u.uid?"You cannot book your own assigned card":"You do not have permission to book this card":"Please log in to make a booking",ee=async()=>{if(!u){b("Please log in to make a booking");return}if(!L()){b(R());return}if(!i||n.length===0){b("Please select a date and at least one time slot");return}if(!r){b("Card information not available");return}if(l>0&&g<=0){b("Please set a valid price per slot for open slots");return}H(!0),b("");try{const t=E(i),s=n.length*(r.pricePerHour||0),a=n.map(p=>{const o={userId:u.uid,cardId:r.id,Card_ID:r.Card_ID,date:t,timeSlot:p,bookingTime:new Date};return l>0&&(o.openSlots=l,o.perSlotPrice=g),q($(D,"bookings"),o)}),h=(await Promise.all(a))[0].id;if(r.assignedHost)try{await q($(D,"notifications"),{userId:r.assignedHost,type:"card_booked",title:"Your card has been booked!",message:`${C?.displayName||u.email} has booked your card "${r.title}" on ${te(i)} at ${n.join(", ")}${l>0?` with ${l} open slots at ₹${g} per slot`:""}`,bookingId:h,bookedByUserId:u.uid,bookedByEmail:u.email,bookedByDisplayName:C?.displayName||"",bookedByPhoneNumber:C?.phoneNumber||"",cardTitle:r.title,bookingDate:t,bookingTimeSlots:n,openSlots:l,perSlotPrice:g,read:!1,createdAt:new Date})}catch{}I(`Successfully booked ${n.length} time slot${n.length>1?"s":""} for ${i.toLocaleDateString()}${l>0?` with ${l} open slots at ₹${g} per slot`:""}`),j(`/receipt/${h}`)}catch{b("Failed to create booking. Please try again.")}finally{H(!1)}},te=t=>t.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric",year:"numeric"}),se=()=>{const t=new Date,s=f.getFullYear(),a=f.getMonth(),c=new Date(s,a+1,0).getDate(),h=new Date(s,a,1).getDay(),p=[];for(let o=0;o<h;o++)p.push(e.jsx("div",{className:"h-10 w-10 sm:h-12 sm:w-12"},`empty-${o}`));for(let o=1;o<=c;o++){const d=new Date(s,a,o),x=d.toDateString()===t.toDateString(),y=i&&d.toDateString()===i.toDateString(),k=d<t&&!x;p.push(e.jsx("button",{onClick:()=>!k&&V(d),disabled:k,className:`
            h-10 w-10 sm:h-12 sm:w-12 rounded-lg flex items-center justify-center text-sm transition-all duration-200
            ${k?"text-gray-300 dark:text-gray-600 cursor-not-allowed":"hover:bg-blue-100 dark:hover:bg-blue-900/30"}
            ${x&&!y?"border-2 border-blue-500 dark:border-blue-400":""}
            ${y?"bg-blue-500 dark:bg-blue-600 text-white hover:bg-blue-600 dark:hover:bg-blue-700":""}
            ${!k&&!y?"hover:bg-gray-100 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100":"text-gray-700 dark:text-gray-300"}
          `,children:o},o))}return p},re=()=>{O(new Date(f.getFullYear(),f.getMonth()-1,1))},ae=()=>{O(new Date(f.getFullYear(),f.getMonth()+1,1))},oe=()=>{const t=[1,2,3,4,5,6,7,8];return e.jsxs("div",{className:"bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-4 sm:p-6 mb-6 border border-blue-200 dark:border-blue-700",children:[e.jsxs("h3",{className:"text-base sm:text-lg font-semibold mb-4 flex items-center text-blue-800 dark:text-blue-300",children:[e.jsx(be,{className:"w-5 h-5 mr-2 text-blue-600 dark:text-blue-400"}),"Slots Open for Other Players (Optional)"]}),e.jsx("p",{className:"text-xs sm:text-sm text-blue-700 dark:text-blue-300 mb-4",children:"Select how many slots you want to keep open for other players to join your game"}),e.jsx("div",{className:"grid grid-cols-4 gap-2 sm:gap-3 mb-4",children:t.map(s=>e.jsxs("button",{onClick:()=>X(l===s?0:s),className:`
                p-3 sm:p-4 rounded-lg border-2 transition-all duration-200 flex flex-col items-center space-y-2
                ${l===s?"border-blue-500 dark:border-blue-400 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 shadow-md":"border-gray-200 dark:border-gray-600 hover:border-blue-300 dark:hover:border-blue-500 text-gray-600 dark:text-gray-400 hover:bg-white dark:hover:bg-gray-800"}
              `,children:[e.jsx("div",{className:"flex space-x-1",children:Array.from({length:s},(a,c)=>e.jsx("div",{className:`w-2 h-2 sm:w-3 sm:h-3 rounded-full ${l===s?"bg-blue-500 dark:bg-blue-400":"bg-gray-300 dark:bg-gray-600"}`},c))}),e.jsx("span",{className:"font-medium text-xs sm:text-sm",children:s})]},s))}),l>0&&e.jsxs("div",{className:"mt-4 p-3 sm:p-4 bg-white dark:bg-gray-800 rounded-lg border border-blue-200 dark:border-blue-700",children:[e.jsx("label",{className:"block text-xs sm:text-sm font-medium text-blue-800 dark:text-blue-300 mb-2",children:"Price Per Slot (₹) *"}),e.jsx("input",{type:"number",value:g||"",onChange:s=>z(parseFloat(s.target.value)||0),onFocus:s=>s.target.select(),placeholder:"Enter price per slot",min:"1",step:"1",required:!0,className:"w-full px-3 py-2 border border-blue-300 dark:border-blue-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"}),e.jsxs("p",{className:"text-blue-700 dark:text-blue-300 text-xs sm:text-sm mt-2",children:[e.jsxs("strong",{children:[l," slots"]})," will be available for other players at ₹",g||0," per slot"]})]})]})};if(J)return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx("div",{className:"flex justify-center items-center min-h-[400px]",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})});if(S&&!r)return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("button",{onClick:()=>j("/"),className:"mb-6 inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Back to home"]}),e.jsxs("div",{className:"text-center bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 sm:p-12",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4",children:"Error"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6 text-sm sm:text-base",children:S}),e.jsxs("button",{onClick:()=>j("/"),className:"inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Return Home"]})]})]});if(!r)return null;if(!L())return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("button",{onClick:()=>j(`/card/${N}`),className:"mb-6 inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200 font-medium",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Back to card details"]}),e.jsxs("div",{className:"text-center bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 sm:p-12",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-gray-900 dark:text-white mb-4",children:"Cannot Book This Card"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 mb-6 text-sm sm:text-base",children:R()}),e.jsxs("button",{onClick:()=>j("/"),className:"inline-flex items-center px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Browse Other Cards"]})]})]});const le=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ne=["January","February","March","April","May","June","July","August","September","October","November","December"];return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("button",{onClick:()=>j(`/card/${N}`),className:"mb-6 inline-flex items-center text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200 font-medium",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Back to card details"]}),e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 lg:p-8",children:[e.jsxs("div",{className:"mb-6 sm:mb-8",children:[e.jsxs("h1",{className:"text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2",children:["Book ",r.title]}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400 text-sm sm:text-base",children:"Select a date and time slots for your booking"}),r.pricePerHour&&e.jsxs("p",{className:"text-base sm:text-lg font-semibold text-green-600 dark:text-green-400 mt-2",children:["₹",r.pricePerHour," per hour"]})]}),S&&e.jsx("div",{className:"mb-6 bg-red-100 dark:bg-red-900/20 border border-red-400 dark:border-red-600 text-red-700 dark:text-red-400 px-4 py-3 rounded-lg",children:e.jsx("span",{className:"text-sm sm:text-base",children:S})}),A&&e.jsx("div",{className:"mb-6 bg-green-100 dark:bg-green-900/20 border border-green-400 dark:border-green-600 text-green-700 dark:text-green-400 px-4 py-3 rounded-lg",children:e.jsx("span",{className:"text-sm sm:text-base",children:A})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg sm:text-xl font-semibold mb-4 flex items-center text-gray-900 dark:text-white",children:[e.jsx(ie,{className:"w-5 h-5 mr-2"}),"Select Date"]}),e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 sm:p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-base sm:text-lg font-medium text-gray-900 dark:text-white",children:[ne[f.getMonth()]," ",f.getFullYear()]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:re,className:"p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full transition-colors duration-200",children:e.jsx(de,{className:"w-4 h-4 sm:w-5 sm:h-5 text-gray-600 dark:text-gray-400"})}),e.jsx("button",{onClick:ae,className:"p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full transition-colors duration-200",children:e.jsx(ce,{className:"w-4 h-4 sm:w-5 sm:h-5 text-gray-600 dark:text-gray-400"})})]})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:le.map(t=>e.jsx("div",{className:"h-6 sm:h-8 flex items-center justify-center text-xs text-gray-500 dark:text-gray-400 font-medium",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:se()})]})]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg sm:text-xl font-semibold mb-4 flex items-center text-gray-900 dark:text-white",children:[e.jsx(me,{className:"w-5 h-5 mr-2"}),"Select Time Slots"]}),i?e.jsxs("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-4 sm:p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("p",{className:"text-xs sm:text-sm text-gray-600 dark:text-gray-400",children:["Selected date: ",e.jsx("span",{className:"font-medium",children:i.toLocaleDateString()})]}),n.length>0&&e.jsxs("p",{className:"text-xs sm:text-sm text-blue-600 dark:text-blue-400 mt-1",children:[n.length," slot",n.length>1?"s":""," selected"]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-64 overflow-y-auto",children:B.map(t=>e.jsxs("button",{onClick:()=>t.available&&Z(t.time),disabled:!t.available,className:`
                        p-2 sm:p-3 rounded-lg text-xs sm:text-sm font-medium transition-all duration-200 flex items-center justify-between
                        ${t.available?n.includes(t.time)?"bg-blue-500 dark:bg-blue-600 text-white hover:bg-blue-600 dark:hover:bg-blue-700":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 border border-gray-200 dark:border-gray-600":"bg-red-100 dark:bg-red-900/20 text-red-400 dark:text-red-500 cursor-not-allowed"}
                      `,children:[e.jsx("span",{children:t.time}),!t.available&&e.jsx(xe,{className:"w-3 h-3 sm:w-4 sm:h-4"}),t.available&&n.includes(t.time)&&e.jsx(ue,{className:"w-3 h-3 sm:w-4 sm:h-4"})]},t.time))}),B.length===0&&e.jsx("p",{className:"text-center text-gray-500 dark:text-gray-400 py-4 text-sm",children:"No time slots available"})]}):e.jsx("div",{className:"bg-gray-50 dark:bg-gray-700/50 rounded-lg p-6 sm:p-8 text-center",children:e.jsx("p",{className:"text-gray-500 dark:text-gray-400 text-sm sm:text-base",children:"Please select a date first"})})]})]}),i&&n.length>0&&e.jsx(oe,{}),i&&n.length>0&&e.jsxs("div",{className:"mt-6 sm:mt-8 bg-gradient-to-br from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-xl p-4 sm:p-6 border border-blue-200 dark:border-blue-700",children:[e.jsx("h3",{className:"text-base sm:text-lg font-semibold mb-4 text-blue-800 dark:text-blue-300",children:"Booking Summary"}),e.jsxs("div",{className:"space-y-2 mb-4 sm:mb-6 text-sm sm:text-base text-gray-700 dark:text-gray-300",children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Card:"})," ",r.title]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",i.toLocaleDateString()]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Time Slots:"})," ",n.join(", ")]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Slots:"})," ",n.length]}),r.pricePerHour&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Price per Hour:"})," ₹",r.pricePerHour]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Total Amount:"})," ",e.jsxs("span",{className:"text-green-600 dark:text-green-400 font-bold",children:["₹",n.length*r.pricePerHour]})]})]}),l>0&&e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Open Slots for Others:"})," ",l]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Price per Slot:"})," ₹",g]}),e.jsxs("p",{children:[e.jsx("span",{className:"font-medium",children:"Potential Revenue:"})," ",e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["₹",l*g]})]})]})]}),e.jsx("button",{onClick:ee,disabled:F||!u||l>0&&g<=0,className:"w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 px-6 rounded-lg hover:from-blue-700 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium text-sm sm:text-base",children:F?"Confirming Booking...":"Confirm Booking"}),!u&&e.jsx("p",{className:"text-center text-red-600 dark:text-red-400 text-xs sm:text-sm mt-2",children:"Please log in to make a booking"}),l>0&&g<=0&&e.jsx("p",{className:"text-center text-red-600 dark:text-red-400 text-xs sm:text-sm mt-2",children:"Please set a valid price per slot"})]})]})]})};export{Ce as default};
